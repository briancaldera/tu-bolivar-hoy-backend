import os
from flask import g
from peewee import PostgresqlDatabase, Database as PeeweeDatabase, SqliteDatabase

class Database:
    @staticmethod
    def get_connection() -> PeeweeDatabase:
        if "db" not in g:

            db_name = os.getenv("DB_NAME")

            if  db_name == "sqlite" and os.getenv("APP_MODE") == "dev":
                db_file = os.getenv("DB_FILE")
                g.db = SqliteDatabase(db_file)

            else:

                db_host = os.getenv("DB_HOST")
                db_port = os.getenv("DB_PORT")
                db_user = os.getenv("DB_USER")
                db_password = os.getenv("DB_PASSWORD")

                g.db = PostgresqlDatabase(
                    db_name,
                    host=db_host,
                    user=db_user,
                    password=db_password,
                    port=db_port,
                )

        conn = g.db
        assert conn.connect(reuse_if_open=True)
        return conn

    @staticmethod
    def close_db(_=None) -> None:
        db: PeeweeDatabase = g.pop("db", None)

        if db is not None:
            db.close()

    def populate_db(self):
        sql = """
        INSERT INTO "public"."currencies" ("id", "currency", "datetime", "rate") VALUES ('0195cf88-cc59-7d7d-9ceb-2df1103b007d', 'EUR', '2025-03-25 23:00:00', '74.29908809'), ('0195cf88-cc5c-7eb3-817f-f59cb8ad5c98', 'TRY', '2025-03-25 23:00:00', '1.80928352'), ('0195cf88-cc5a-714d-9182-65fa8ccede46', 'RUB', '2025-03-25 23:00:00', '0.81177041'), ('0195cf88-cc5b-7ce9-9b1f-5a1175dd222b', 'CNY', '2025-03-25 23:00:00', '9.46663910'), ('0195cf88-cc58-7fc0-90e1-fcf205264c7e', 'USD', '2025-03-25 23:00:00', '68.69940000'), ('0195cf51-e411-79da-bd62-d529a58e4bd1', 'TRY', '2025-03-25 22:00:00', '1.80928352'), ('0195cf51-e40e-725f-8e38-28f91bc6e831', 'EUR', '2025-03-25 22:00:00', '74.29908809'), ('0195cf51-e40d-7f61-bafa-3261a3a65f81', 'USD', '2025-03-25 22:00:00', '68.69940000'), ('0195cf51-e40f-7fd7-8bf1-11f356f76ad4', 'RUB', '2025-03-25 22:00:00', '0.81177041'), ('0195cf51-e410-7b05-8a18-f17dc2d7547b', 'CNY', '2025-03-25 22:00:00', '9.46663910'), ('0195cf1b-050f-7e80-94ac-5396102e91d0', 'USD', '2025-03-25 21:00:00', '68.69940000'), ('0195cf1b-0511-786c-9502-81cc227b06b8', 'RUB', '2025-03-25 21:00:00', '0.81177041'), ('0195cf1b-0512-7b25-9d36-67482d55b46a', 'CNY', '2025-03-25 21:00:00', '9.46663910'), ('0195cf1b-0513-74b1-83ae-46854bc7a7f2', 'TRY', '2025-03-25 21:00:00', '1.80928352'), ('0195cf1b-0510-7837-a0de-201d41ae9cb7', 'EUR', '2025-03-25 21:00:00', '74.29908809'), ('0195cee4-05b0-7f08-ba4f-b19fd51c7fca', 'CNY', '2025-03-25 20:00:00', '9.46663910'), ('0195cee4-05af-7d79-97ab-fdec7e9a1cba', 'RUB', '2025-03-25 20:00:00', '0.81177041'), ('0195cee4-05ae-7b6a-b6cc-45a0e988094e', 'EUR', '2025-03-25 20:00:00', '74.29908809'), ('0195cee4-05b1-70f9-b95e-c83dd9674687', 'TRY', '2025-03-25 20:00:00', '1.80928352'), ('0195cee4-05ad-774b-a907-50aea1bf9c13', 'USD', '2025-03-25 20:00:00', '68.69940000'), ('0195cead-1969-740d-a1a1-db6ecc36cd02', 'RUB', '2025-03-25 19:00:00', '0.81273305'), ('0195cead-1968-7faa-825a-baf3a6219b0e', 'EUR', '2025-03-25 19:00:00', '73.85072534'), ('0195cead-196a-7af9-acf7-cfd61803db5b', 'CNY', '2025-03-25 19:00:00', '9.43021812'), ('0195cead-1967-713d-8c81-677a93b9a010', 'USD', '2025-03-25 19:00:00', '68.39360000'), ('0195cead-196b-70dc-9001-e05b94bdcc7b', 'TRY', '2025-03-25 19:00:00', '1.80004047'), ('0195ce76-29fe-7a70-9c94-41001b9d4563', 'USD', '2025-03-25 18:00:00', '68.39360000'), ('0195ce76-2a00-7bb1-b644-ffe46abd0286', 'RUB', '2025-03-25 18:00:00', '0.81273305'), ('0195ce76-2a01-784a-9b7c-59984dd60b28', 'CNY', '2025-03-25 18:00:00', '9.43021812'), ('0195ce76-2a02-7dc0-80d9-28ac67d975e5', 'TRY', '2025-03-25 18:00:00', '1.80004047'), ('0195ce76-29ff-755c-a3f4-ee736d97de32', 'EUR', '2025-03-25 18:00:00', '73.85072534'), ('0195ce3f-3eb0-76a9-8fc6-dd493089374b', 'EUR', '2025-03-25 17:00:00', '73.85072534'), ('0195ce3f-3eb1-755c-8ea6-119685992985', 'RUB', '2025-03-25 17:00:00', '0.81273305'), ('0195ce3f-3eaf-7fba-bb16-3ca9dcfaccb0', 'USD', '2025-03-25 17:00:00', '68.39360000'), ('0195ce3f-3eb3-75b2-bd5c-9379a918f1c7', 'TRY', '2025-03-25 17:00:00', '1.80004047'), ('0195ce3f-3eb2-7d00-adfb-75dd4b2360b5', 'CNY', '2025-03-25 17:00:00', '9.43021812'), ('0195ce08-4b94-7eb4-b85e-19057ee1a459', 'EUR', '2025-03-25 16:00:00', '73.85072534'), ('0195ce08-4b93-7636-a4f9-8410592dbad3', 'USD', '2025-03-25 16:00:00', '68.39360000'), ('0195ce08-4b97-737a-b25e-d41dccfef1b5', 'TRY', '2025-03-25 16:00:00', '1.80004047'), ('0195ce08-4b95-7795-a1f1-396bbe24b09e', 'RUB', '2025-03-25 16:00:00', '0.81273305'), ('0195ce08-4b96-7057-a4ca-b670ccfa89b8', 'CNY', '2025-03-25 16:00:00', '9.43021812'), ('0195cdd1-5de8-76ed-b0c6-888565d232ca', 'USD', '2025-03-25 15:00:00', '68.39360000'), ('0195cdd1-5deb-742d-8968-e8a7a15f7526', 'CNY', '2025-03-25 15:00:00', '9.43021812'), ('0195cdd1-5de9-751c-8f3f-d06d35194d7e', 'EUR', '2025-03-25 15:00:00', '73.85072534'), ('0195cdd1-5dea-71e2-8c17-18206a058ec6', 'RUB', '2025-03-25 15:00:00', '0.81273305'), ('0195cdd1-5dec-7df4-b4e4-607938745707', 'TRY', '2025-03-25 15:00:00', '1.80004047'), ('0195cd9a-6dbd-7b78-ba9c-789cbe72b9fd', 'EUR', '2025-03-25 14:00:00', '73.85072534'), ('0195cd9a-6dbc-7e2b-9b5c-67c1bfedabd6', 'USD', '2025-03-25 14:00:00', '68.39360000'), ('0195cd9a-6dbe-74b1-bc61-a14aa76f2f92', 'RUB', '2025-03-25 14:00:00', '0.81273305'), ('0195cd9a-6dc0-7667-b96d-45a192a2d28c', 'TRY', '2025-03-25 14:00:00', '1.80004047'), ('0195cd9a-6dbf-7ad8-8850-1e1af8009b79', 'CNY', '2025-03-25 14:00:00', '9.43021812');
        """

        conn = self.get_connection()

        with conn.atomic():
            try:
                conn.execute_sql(sql)
                conn.commit()

            except Exception as e:
                print(e)
                conn.rollback()
